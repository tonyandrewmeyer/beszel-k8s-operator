# This file configures Charmcraft.
# See https://documentation.ubuntu.com/charmcraft/stable/reference/files/charmcraft-yaml-file/
type: charm
name: beszel
title: Beszel Hub
summary: Lightweight server monitoring with Docker stats and historical data
description: |
  Beszel is a lightweight server monitoring platform that provides
  Docker/Podman statistics, historical data, and customizable alerts.

  This charm deploys the Beszel Hub component, which serves as the central
  dashboard for viewing and managing monitored systems.

  The Hub is built on PocketBase and provides a web interface for
  configuring systems, viewing metrics, and managing alerts.

  Useful for system administrators and DevOps teams who need lightweight,
  resource-efficient monitoring without the overhead of heavier solutions.

# Documentation:
# https://documentation.ubuntu.com/charmcraft/stable/howto/build-guides/select-platforms/
base: ubuntu@22.04
platforms:
  amd64:
  arm64:

parts:
  charm:
    plugin: uv
    source: .
    build-snaps:
      - astral-uv

# Configuration options for the charm
config:
  options:
    container-image:
      description: |
        OCI image to use for the Beszel Hub.
        Allows pinning to specific versions or using custom builds.
      default: "henrygd/beszel:latest"
      type: string

    port:
      description: |
        Port on which the Beszel Hub listens.
      default: 8090
      type: int

    external-hostname:
      description: |
        External hostname for OAuth callback URLs (e.g., "beszel.example.com").
        Required when using oauth relation with identity platform.
        If not set, falls back to local authentication only.
      default: ""
      type: string

    s3-backup-enabled:
      description: |
        Enable automatic backups to S3-compatible storage.
        Requires s3-credentials relation to be established.
      default: false
      type: boolean

    s3-endpoint:
      description: |
        S3-compatible storage endpoint URL.
        Required if s3-backup-enabled is true.
      default: ""
      type: string

    s3-bucket:
      description: |
        S3 bucket name for backups.
      default: ""
      type: string

    s3-region:
      description: |
        S3 region.
      default: "us-east-1"
      type: string

    log-level:
      description: |
        Log verbosity level.
        Acceptable values are: "info", "debug", "warning", "error"
      default: "info"
      type: string

# Your workload's containers.
containers:
  beszel:
    resource: beszel-image

# Storage for PocketBase database and backups
storage:
  beszel-data:
    type: filesystem
    description: PocketBase database, configuration, and local backups
    minimum-size: 1G
    location: /beszel_data

# This field populates the Resources tab on Charmhub.
resources:
  beszel-image:
    type: oci-image
    description: OCI image for the Beszel Hub container
    upstream-source: henrygd/beszel:latest

# Relations (Integrations)
requires:
  ingress:
    interface: ingress
    optional: true
    limit: 1

  oauth:
    interface: oauth
    optional: true
    limit: 1

  s3-credentials:
    interface: s3
    optional: true
    limit: 1

# Actions
actions:
  get-admin-url:
    description: Get the URL to access the Beszel Hub admin interface

  create-agent-token:
    description: Create a universal token for agent authentication
    params:
      description:
        description: Description for the token
        type: string
        default: ""

  backup-now:
    description: Trigger an immediate backup

  list-backups:
    description: List available backups
